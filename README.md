# **R2 Admin 部署教程**



## **简介**

一个部署在 **Cloudflare Pages** 上的 **Cloudflare R2 文件管理面板**，弥补了官方文件管理面板的文件操作限制和文件上传限制；

不需要自建服务器和域名，如果追求速度体验可以绑定自己的二级域名，使用 Cloudflare Pages + R2 绑定实现桶内文件的 查看、大文件上传、预览、下载与批量对文件功能性的操作。



## **功能**

- 多个存储桶切换（Pages 需要设置绑定多个 R2 存储桶）
- 文件与文件夹列表模式浏览
- 大文件分片上传，突破官方网站 300M 的上限限制，支持 暂停 / 继续续传 / 取消
- 在线预览：暂时支持 图片 / 音频 / 视频 / PDF / 代码 / Office 在线预览
- 文件操作：上传 / 下载 / 重命名 / 移动 / 复制 / 删除 / 新建文件夹 / 复制自定义链接 / 复制公共链接
- 支持文件和文件夹多选并进行批量操作
- 全局搜索（当前桶内扫描匹配）支持搜索后缀名
- 可选访问密码：设置 `ADMIN_PASSWORD` 变量后启用登录页与 API 鉴权
- 配置 R2 直连后可切换三种传输模式（自动、R2 直连、Pages 代理）
- 可查看当前账号和当前存储桶的存储空间使用数据
- 管理面板界面主题切换：跟随系统、浅色模式、深色模式



## **部署到 Cloudflare Pages**

### 第一步：创建 Cloudflare Pages 项目

**登陆 Cloudflare 仪表盘：**计算和AI → Workers 和 Pages → 创建应用程序 → Pages → 拖放文件 → 创建名称并选择本项目文件夹。

### 第二步：构建配置

- 框架预设：`Next.js`
- 构建命令：`npx @cloudflare/next-on-pages@1`
- 构建输出目录：`.vercel/output/static`
- 兼容性标志：添加 `nodejs_compat`（生产 / 预览）

**上述步骤全部操作完成后部署即可；然后接着下面的步骤操作。**

### 第三步：绑定 R2 存储桶

**Workers 和 Pages → 设置 →  绑定 → 添加：**

- 类型：R2 存储桶
- 名称：建议英文且以 `R2_` 开头（例如 `R2_BLOG`、`R2_CLOUD`）
- 选择你的 R2 存储桶

**如果需要管理多个存储桶文件，那就绑定多个，绑定完成后重新部署一次，页面就会显示桶列表并可操作文件。**

### 第四步：设置账号和密码（非必须但建议）

**Workers 和 Pages → 设置 → 变量和机密 → 添加：**

| 类型 | 名称（必须）     | 值（示例）     | 说明 |
| ---- | ---------------- | :------------- | ---- |
| 文本 | `ADMIN_USERNAME` | wangqing       | 账号 |
| 密钥 | `ADMIN_PASSWORD` | wangqing123456 | 密码 |

设置完成保存，并重新部署成功后，再次打开网站会弹出**「管理员登陆」**界面。



## **启用 R2 直连模式（非必须但建议）**

默认情况下，本项目会通过 Pages Functions + R2 Binding（/api/object）代理文件流。
如果你希望 预览 / 上传 / 下载 速度更快、更稳定，并且浏览器能显示下载总大小，推荐启用 **S3 预签名直连**：

**需要在 Pages → 设置 → 变量和机密 → 添加：**

| 变量名                 | 类型 | 说明         |
| ---------------------- | ---- | ------------ |
| `R2_ACCOUNT_ID`        | 文本 | 账户 ID      |
| `R2_ACCESS_KEY_ID`     | 密钥 | 访问密钥 ID  |
| `R2_SECRET_ACCESS_KEY` | 密钥 | 机密访问密钥 |

注意：配置完成以上信息后，重新部署，打开网站，在页面左侧底部的「链接设置」里，为每个绑定填写一次 **R2 桶名**（真实的存储桶名称）即可开启 R2 直连模式。配置齐全后，`/api/download` 会优先返回 presigned URL；未配置则自动回退到 Pages 代理模式。通过「链接设置」填写桶名时，系统会自动做一次桶名校验；校验失败会提示原因，并在预览/下载时自动回退到 Pages 代理。

**你可以在页面左侧「连接状态正常」卡片里看到当前传输通道提示：**

- `当前传输通道：R2 直连`：预览/下载会走 R2 直连
- `当前传输通道：Pages 代理`：预览/下载会走 Pages 代理（`/api/object`）
- 当需要提示原因时，会额外显示第三行，例如：`桶名未校验：xxx` / `桶名校验失败：xxx...已回退至「Pages 代理」`

**并且你可以在其下方的「选择传输通道」里手动切换（按桶保存）：**

- `自动`（默认）：满足直连条件时用 R2 直连，否则回退 Pages 代理
- `R2 直连`：优先尝试直连（桶名校验失败仍会回退 Pages 代理）
- `Pages 代理`：强制走 Pages 代理

备注：文件列表/重命名/移动/上传等“管理操作”始终通过 Pages Functions + R2 Binding 完成；“R2 直连”只影响预览/下载这类大流量的数据传输。